"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MahafuncArray = void 0;
const index_1 = require("./index");
const Mahafunc_1 = require("./Mahafunc");
const PageProcessor_1 = require("./PageProcessor");
const CustomElement_1 = require("./CustomElement");
const Munger_1 = require("./Munger");
const util = __importStar(require("util"));
const _mahaarray_name = Symbol('name');
const _mahaarray_options = Symbol('options');
const _mahaarray_functions = Symbol('functions');
const _mahaarray_final_functions = Symbol('final_functions');
/**
 * Holds a series of functions ({@link Mahafunc}) that
 * will execute in the order they were added.
 */
class MahafuncArray {
    constructor(name, config) {
        this[_mahaarray_functions] = [];
        this[_mahaarray_final_functions] = [];
        this[_mahaarray_name] = name;
        this[_mahaarray_options] = config;
        // console.log(`new MahafuncArray ${this[_mahaarray_name]} ${util.inspect(this[_mahaarray_options])}`);
    }
    /**
     * Retrieve the configuration object supplied
     * to the array.
     */
    get options() { return this[_mahaarray_options]; }
    /**
     * Retrieve the name for the array.  This name is
     * purely for informational purposes.
     */
    get name() { return this[_mahaarray_name]; }
    /**
     * Retrieve the array of functions.
     */
    get functions() { return this[_mahaarray_functions]; }
    /**
     * Retrieve the array of _final_ functions.  These are
     * executed after the main array is fully finished.
     */
    get final_functions() { return this[_mahaarray_final_functions]; }
    /**
     * Return the number of elements in the function array.
     */
    get length() { return this[_mahaarray_functions].length; }
    /**
     * Return the number of elements in
     * the final function array.
     */
    get length_final() { return this[_mahaarray_final_functions].length; }
    /**
     * Add a function to the array.
     *
     * For historical purposes we support several types
     * of function.  It's preferable to use {@link Mahafunc}
     * objects, or other {@link MahafuncArray}'s.  But we
     * also allow bare functions.
     *
     * @param func A single item of type {@link MahafuncType}
     * @returns To support chaining, the array is returned
     */
    addMahafunc(func) {
        if (!(func instanceof Mahafunc_1.Mahafunc
            || func instanceof MahafuncArray
            || typeof func === 'function'
            || Array.isArray(func))) {
            throw new Error("Improper addition " + util.inspect(func));
        }
        else {
            this.functions.push(func);
            if (func instanceof Mahafunc_1.Mahafunc) {
                func.array = this;
            }
        }
        return this; // support chaining
    }
    /**
     * Replace any existing function array with a
     * new array of either {@link Mahafunc} or
     * {@link MahafuncArray} objects
     *
     * @param functions
     * @returns To support chaining, the array is returned
     */
    setMahafuncArray(functions) {
        if (!(Array.isArray(functions))) {
            throw new Error("Improper mahafunction array " + util.inspect(functions));
        }
        else {
            this[_mahaarray_functions] = functions;
            for (let func of this[_mahaarray_functions]) {
                if (func instanceof Mahafunc_1.Mahafunc) {
                    func.array = this;
                }
            }
        }
        return this; // support chaining
    }
    /**
     * Replace any existing final function array with a
     * new array of either {@link Mahafunc} or
     * {@link MahafuncArray} objects
     *
     * @param functions
     * @returns To support chaining, the array is returned
     */
    setFinalMahafuncArray(final_functions) {
        if (!(Array.isArray(final_functions))) {
            throw new Error("Improper mahafunction array " + util.inspect(final_functions));
        }
        else {
            this[_mahaarray_final_functions] = final_functions;
            for (let func of this[_mahaarray_final_functions]) {
                if (func instanceof Mahafunc_1.Mahafunc) {
                    func.array = this;
                }
            }
        }
        return this; // support chaining
    }
    /**
     * Add a function to the array.
     *
     * For historical purposes we support several types
     * of function.  It's preferable to use {@link Mahafunc}
     * objects, or other {@link MahafuncArray}'s.  But we
     * also allow bare functions.
     *
     * @param func A single item of type {@link MahafuncType}
     * @returns To support chaining, the array is returned
     */
    addFinalMahafunc(func) {
        if (!(func instanceof Mahafunc_1.Mahafunc
            || func instanceof MahafuncArray
            || typeof func === 'function'
            || Array.isArray(func))) {
            throw new Error("Improper addition " + util.inspect(func));
        }
        else {
            this.final_functions.push(func);
            if (func instanceof Mahafunc_1.Mahafunc) {
                func.array = this;
            }
        }
        return this; // support chaining
    }
    /**
     * Execute the functions in the array.
     *
     * @param $ The parsed form of the HTML ready to use with Cheerio functions
     * @param metadata A metadata object supplied by the application, and passed through to functions.
     * @param dirty A function provided by {@link processAsync} that notifies whether a function has inserted something in the HTML which requires further processing.
     * @returns
     */
    async process($, metadata, dirty) {
        (0, index_1.logProcessing)(`Mahabhuta starting array ${this.name}`);
        const loops = [];
        // const startProcessing = new Date();
        // Run the functions, then run the final_functions
        for (let funclist of [this.functions, this.final_functions]) {
            for (let mahafunc of funclist) {
                if (mahafunc instanceof CustomElement_1.CustomElement) {
                    (0, index_1.logProcessing)(`Mahabhuta calling CustomElement ${this.name} ${mahafunc.elementName}`);
                    try {
                        await mahafunc.processAll($, metadata, dirty);
                    }
                    catch (errCustom) {
                        throw new Error(`Mahabhuta ${this.name} caught error in CustomElement(${mahafunc.elementName}): ${errCustom.message}`);
                    }
                    // loops.push(`... CustomElement ${mahafunc.elementName} ${(new Date() - startProcessing) / 1000} seconds`);
                }
                else if (mahafunc instanceof Munger_1.Munger) {
                    (0, index_1.logProcessing)(`Mahabhuta calling Munger ${this.name} ${mahafunc.selector}`);
                    try {
                        await mahafunc.processAll($, metadata, dirty);
                    }
                    catch (errMunger) {
                        throw new Error(`Mahabhuta ${this.name} caught error in Munger(${mahafunc.selector}): ${errMunger.message}`);
                    }
                    (0, index_1.logProcessing)(`Mahabhuta FINISHED Munger ${this.name} ${mahafunc.selector}`);
                    // loops.push(`... Munger ${mahafunc.selector} ${(new Date() - startProcessing) / 1000} seconds`);
                }
                else if (mahafunc instanceof PageProcessor_1.PageProcessor) {
                    // Performance testing
                    const _start = new Date();
                    (0, index_1.logProcessing)(`Mahabhuta calling ${this.name} PageProcessor `);
                    try {
                        await mahafunc.process($, metadata, dirty);
                    }
                    catch (errPageProcessor) {
                        throw new Error(`Mahabhuta ${this.name} caught error in PageProcessor: ${errPageProcessor.message}`);
                    }
                    // Performance testing
                    (0, index_1.logPerformance)(_start, `PageProcessor ${this.name}`);
                    // loops.push(`... PageProcessor ${(new Date() - startProcessing) / 1000} seconds`);
                }
                else if (mahafunc instanceof MahafuncArray) {
                    // Performance testing
                    const _start = new Date();
                    let results = [];
                    try {
                        results = await mahafunc.process($, metadata, dirty);
                    }
                    catch (errMahafuncArray) {
                        throw new Error(`Mahabhuta ${this.name} caught error in MahafuncArray: ${errMahafuncArray.message}`);
                    }
                    // Performance testing
                    (0, index_1.logPerformance)(_start, `MahafuncArray ${this.name} ${mahafunc.name}`);
                    // results.forEach(result => { loops.push(`    ... "${mahafunc.name} result" ${result} ${(new Date() - startProcessing) / 1000} seconds`); });
                    // loops.push(`... MahafuncArray ${mahafunc.name} ${(new Date() - startProcessing) / 1000} seconds`);
                }
                else if (typeof mahafunc === 'function') {
                    // Performance testing
                    const _start = new Date();
                    (0, index_1.logProcessing)(`Mahabhuta calling an ${this.name} "function" `);
                    try {
                        await new Promise((resolve, reject) => {
                            mahafunc($, metadata, dirty, err => {
                                if (err)
                                    reject(err);
                                else
                                    resolve('ok');
                            });
                        });
                    }
                    catch (errFunction) {
                        throw new Error(`Mahabhuta ${this.name} caught error in function: ${errFunction.message}`);
                    }
                    // Performance testing
                    (0, index_1.logPerformance)(_start, `function ${this.name}`);
                    // loops.push(`... MahafuncArray "function" ${(new Date() - startProcessing) / 1000} seconds`);
                }
                else if (Array.isArray(mahafunc)) {
                    // Performance testing
                    const _start = new Date();
                    let mhObj = new MahafuncArray("inline", this.options);
                    mhObj.setMahafuncArray(mahafunc);
                    let results = await mhObj.process($, metadata, dirty);
                    // Performance testing
                    (0, index_1.logPerformance)(_start, `Array ${this.name} inline`);
                    // results.forEach(result => { loops.push(`    ... "inline result" ${result} ${(new Date() - startProcessing) / 1000} seconds`); });
                    // loops.push(`... MahafuncArray "inline array" ${(new Date() - startProcessing) / 1000} seconds`);
                }
                else {
                    console.error(`BAD MAHAFUNC in array ${this.name} - ${util.inspect(mahafunc)}`);
                }
            }
        }
        // return $.html();
        return loops;
    }
}
exports.MahafuncArray = MahafuncArray;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFoYWZ1bmNBcnJheS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9NYWhhZnVuY0FycmF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSxtQ0FBd0Q7QUFDeEQseUNBQXNDO0FBQ3RDLG1EQUFnRDtBQUNoRCxtREFBZ0Q7QUFDaEQscUNBQWtDO0FBQ2xDLDJDQUE2QjtBQUk3QixNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDdkMsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDN0MsTUFBTSxvQkFBb0IsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDakQsTUFBTSwwQkFBMEIsR0FBRyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUU3RDs7O0dBR0c7QUFDSCxNQUFhLGFBQWE7SUFFdEIsWUFBWSxJQUFZLEVBQUUsTUFBYztRQUNwQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDN0IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsTUFBTSxDQUFDO1FBQ2xDLHVHQUF1RztJQUMzRyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsSUFBSSxPQUFPLEtBQUssT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFbEQ7OztPQUdHO0lBQ0gsSUFBSSxJQUFJLEtBQUssT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTVDOztPQUVHO0lBQ0gsSUFBSSxTQUFTLEtBQUssT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFdEQ7OztPQUdHO0lBQ0gsSUFBSSxl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RUFBRSxDQUFDLENBQUM7b0JBQ2hELCtGQUErRjtpQkFDbEc7cUJBQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO29CQUNoQyxzQkFBc0I7b0JBQ3RCLE1BQU0sTUFBTSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7b0JBQzFCLElBQUksS0FBSyxHQUFHLElBQUksYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQ3RELEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDakMsSUFBSSxPQUFPLEdBQUcsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQ3RELHNCQUFzQjtvQkFDdEIsSUFBQSxzQkFBYyxFQUFDLE1BQU0sRUFBRSxTQUFTLElBQUksQ0FBQyxJQUFJLFNBQVMsQ0FBQyxDQUFDO29CQUNwRCxvSUFBb0k7b0JBQ3BJLG1HQUFtRztpQkFDdEc7cUJBQU07b0JBQ0gsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsSUFBSSxDQUFDLElBQUksTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDbkY7YUFDSjtTQUNKO1FBQ0QsbUJBQW1CO1FBQ25CLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FDSjtBQTFPRCxzQ0EwT0MiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IGxvZ1Byb2Nlc3NpbmcsIGxvZ1BlcmZvcm1hbmNlIH0gZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgeyBNYWhhZnVuYyB9IGZyb20gJy4vTWFoYWZ1bmMnO1xuaW1wb3J0IHsgUGFnZVByb2Nlc3NvciB9IGZyb20gJy4vUGFnZVByb2Nlc3Nvcic7XG5pbXBvcnQgeyBDdXN0b21FbGVtZW50IH0gZnJvbSAnLi9DdXN0b21FbGVtZW50JztcbmltcG9ydCB7IE11bmdlciB9IGZyb20gJy4vTXVuZ2VyJztcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSAndXRpbCc7XG5cbmV4cG9ydCB0eXBlIE1haGFmdW5jVHlwZSA9IE1haGFmdW5jIHwgTWFoYWZ1bmNBcnJheSB8IEZ1bmN0aW9uIHwgW107XG5cbmNvbnN0IF9tYWhhYXJyYXlfbmFtZSA9IFN5bWJvbCgnbmFtZScpO1xuY29uc3QgX21haGFhcnJheV9vcHRpb25zID0gU3ltYm9sKCdvcHRpb25zJyk7XG5jb25zdCBfbWFoYWFycmF5X2Z1bmN0aW9ucyA9IFN5bWJvbCgnZnVuY3Rpb25zJyk7XG5jb25zdCBfbWFoYWFycmF5X2ZpbmFsX2Z1bmN0aW9ucyA9IFN5bWJvbCgnZmluYWxfZnVuY3Rpb25zJyk7XG5cbi8qKlxuICogSG9sZHMgYSBzZXJpZXMgb2YgZnVuY3Rpb25zICh7QGxpbmsgTWFoYWZ1bmN9KSB0aGF0IFxuICogd2lsbCBleGVjdXRlIGluIHRoZSBvcmRlciB0aGV5IHdlcmUgYWRkZWQuXG4gKi9cbmV4cG9ydCBjbGFzcyBNYWhhZnVuY0FycmF5IHtcblxuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgY29uZmlnOiBPYmplY3QpIHtcbiAgICAgICAgdGhpc1tfbWFoYWFycmF5X2Z1bmN0aW9uc10gPSBbXTtcbiAgICAgICAgdGhpc1tfbWFoYWFycmF5X2ZpbmFsX2Z1bmN0aW9uc10gPSBbXTtcbiAgICAgICAgdGhpc1tfbWFoYWFycmF5X25hbWVdID0gbmFtZTtcbiAgICAgICAgdGhpc1tfbWFoYWFycmF5X29wdGlvbnNdID0gY29uZmlnO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhgbmV3IE1haGFmdW5jQXJyYXkgJHt0aGlzW19tYWhhYXJyYXlfbmFtZV19ICR7dXRpbC5pbnNwZWN0KHRoaXNbX21haGFhcnJheV9vcHRpb25zXSl9YCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmUgdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHN1cHBsaWVkXG4gICAgICogdG8gdGhlIGFycmF5LlxuICAgICAqL1xuICAgIGdldCBvcHRpb25zKCkgeyByZXR1cm4gdGhpc1tfbWFoYWFycmF5X29wdGlvbnNdOyB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZSB0aGUgbmFtZSBmb3IgdGhlIGFycmF5LiAgVGhpcyBuYW1lIGlzXG4gICAgICogcHVyZWx5IGZvciBpbmZvcm1hdGlvbmFsIHB1cnBvc2VzLlxuICAgICAqL1xuICAgIGdldCBuYW1lKCkgeyByZXR1cm4gdGhpc1tfbWFoYWFycmF5X25hbWVdOyB9XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZSB0aGUgYXJyYXkgb2YgZnVuY3Rpb25zLlxuICAgICAqL1xuICAgIGdldCBmdW5jdGlvbnMoKSB7IHJldHVybiB0aGlzW19tYWhhYXJyYXlfZnVuY3Rpb25zXTsgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmUgdGhlIGFycmF5IG9mIF9maW5hbF8gZnVuY3Rpb25zLiAgVGhlc2UgYXJlXG4gICAgICogZXhlY3V0ZWQgYWZ0ZXIgdGhlIG1haW4gYXJyYXkgaXMgZnVsbHkgZmluaXNoZWQuXG4gICAgICovXG4gICAgZ2V0IGZpbmFsX2Z1bmN0aW9ucygpIHsgcmV0dXJuIHRoaXNbX21haGFhcnJheV9maW5hbF9mdW5jdGlvbnNdOyB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiB0aGUgZnVuY3Rpb24gYXJyYXkuXG4gICAgICovXG4gICAgZ2V0IGxlbmd0aCgpOiBudW1iZXIgeyByZXR1cm4gdGhpc1tfbWFoYWFycmF5X2Z1bmN0aW9uc10ubGVuZ3RoOyB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBcbiAgICAgKiB0aGUgZmluYWwgZnVuY3Rpb24gYXJyYXkuXG4gICAgICovXG4gICAgZ2V0IGxlbmd0aF9maW5hbCgpOiBudW1iZXIgeyByZXR1cm4gdGhpc1tfbWFoYWFycmF5X2ZpbmFsX2Z1bmN0aW9uc10ubGVuZ3RoOyB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBmdW5jdGlvbiB0byB0aGUgYXJyYXkuXG4gICAgICogXG4gICAgICogRm9yIGhpc3RvcmljYWwgcHVycG9zZXMgd2Ugc3VwcG9ydCBzZXZlcmFsIHR5cGVzXG4gICAgICogb2YgZnVuY3Rpb24uICBJdCdzIHByZWZlcmFibGUgdG8gdXNlIHtAbGluayBNYWhhZnVuY31cbiAgICAgKiBvYmplY3RzLCBvciBvdGhlciB7QGxpbmsgTWFoYWZ1bmNBcnJheX0ncy4gIEJ1dCB3ZVxuICAgICAqIGFsc28gYWxsb3cgYmFyZSBmdW5jdGlvbnMuXG4gICAgICogXG4gICAgICogQHBhcmFtIGZ1bmMgQSBzaW5nbGUgaXRlbSBvZiB0eXBlIHtAbGluayBNYWhhZnVuY1R5cGV9XG4gICAgICogQHJldHVybnMgVG8gc3VwcG9ydCBjaGFpbmluZywgdGhlIGFycmF5IGlzIHJldHVybmVkXG4gICAgICovXG4gICAgYWRkTWFoYWZ1bmMoZnVuYzogTWFoYWZ1bmNUeXBlKTogTWFoYWZ1bmNBcnJheSB7XG4gICAgICAgIGlmICghKGZ1bmMgaW5zdGFuY2VvZiBNYWhhZnVuY1xuICAgICAgICAgICB8fCBmdW5jIGluc3RhbmNlb2YgTWFoYWZ1bmNBcnJheVxuICAgICAgICAgICB8fCB0eXBlb2YgZnVuYyA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgICAgICB8fCBBcnJheS5pc0FycmF5KGZ1bmMpKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW1wcm9wZXIgYWRkaXRpb24gXCIrIHV0aWwuaW5zcGVjdChmdW5jKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmZ1bmN0aW9ucy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgaWYgKGZ1bmMgaW5zdGFuY2VvZiBNYWhhZnVuYykge1xuICAgICAgICAgICAgICAgIGZ1bmMuYXJyYXkgPSB0aGlzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzOyAvLyBzdXBwb3J0IGNoYWluaW5nXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbnkgZXhpc3RpbmcgZnVuY3Rpb24gYXJyYXkgd2l0aCBhXG4gICAgICogbmV3IGFycmF5IG9mIGVpdGhlciB7QGxpbmsgTWFoYWZ1bmN9IG9yIFxuICAgICAqIHtAbGluayBNYWhhZnVuY0FycmF5fSBvYmplY3RzXG4gICAgICogXG4gICAgICogQHBhcmFtIGZ1bmN0aW9ucyBcbiAgICAgKiBAcmV0dXJucyBUbyBzdXBwb3J0IGNoYWluaW5nLCB0aGUgYXJyYXkgaXMgcmV0dXJuZWRcbiAgICAgKi9cbiAgICBzZXRNYWhhZnVuY0FycmF5KGZ1bmN0aW9uczogQXJyYXk8TWFoYWZ1bmMgfCBNYWhhZnVuY0FycmF5Pik6IE1haGFmdW5jQXJyYXkge1xuICAgICAgICBpZiAoIShBcnJheS5pc0FycmF5KGZ1bmN0aW9ucykpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbXByb3BlciBtYWhhZnVuY3Rpb24gYXJyYXkgXCIrIHV0aWwuaW5zcGVjdChmdW5jdGlvbnMpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXNbX21haGFhcnJheV9mdW5jdGlvbnNdID0gZnVuY3Rpb25zO1xuICAgICAgICAgICAgZm9yIChsZXQgZnVuYyBvZiB0aGlzW19tYWhhYXJyYXlfZnVuY3Rpb25zXSkge1xuICAgICAgICAgICAgICAgIGlmIChmdW5jIGluc3RhbmNlb2YgTWFoYWZ1bmMpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYy5hcnJheSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzOyAvLyBzdXBwb3J0IGNoYWluaW5nXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbnkgZXhpc3RpbmcgZmluYWwgZnVuY3Rpb24gYXJyYXkgd2l0aCBhXG4gICAgICogbmV3IGFycmF5IG9mIGVpdGhlciB7QGxpbmsgTWFoYWZ1bmN9IG9yIFxuICAgICAqIHtAbGluayBNYWhhZnVuY0FycmF5fSBvYmplY3RzXG4gICAgICogXG4gICAgICogQHBhcmFtIGZ1bmN0aW9ucyBcbiAgICAgKiBAcmV0dXJucyBUbyBzdXBwb3J0IGNoYWluaW5nLCB0aGUgYXJyYXkgaXMgcmV0dXJuZWRcbiAgICAgKi9cbiAgICBzZXRGaW5hbE1haGFmdW5jQXJyYXkoZmluYWxfZnVuY3Rpb25zOiBBcnJheTxNYWhhZnVuYz4pOiBNYWhhZnVuY0FycmF5IHtcbiAgICAgICAgaWYgKCEoQXJyYXkuaXNBcnJheShmaW5hbF9mdW5jdGlvbnMpKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW1wcm9wZXIgbWFoYWZ1bmN0aW9uIGFycmF5IFwiKyB1dGlsLmluc3BlY3QoZmluYWxfZnVuY3Rpb25zKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzW19tYWhhYXJyYXlfZmluYWxfZnVuY3Rpb25zXSA9IGZpbmFsX2Z1bmN0aW9ucztcbiAgICAgICAgICAgIGZvciAobGV0IGZ1bmMgb2YgdGhpc1tfbWFoYWFycmF5X2ZpbmFsX2Z1bmN0aW9uc10pIHtcbiAgICAgICAgICAgICAgICBpZiAoZnVuYyBpbnN0YW5jZW9mIE1haGFmdW5jKSB7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMuYXJyYXkgPSB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpczsgLy8gc3VwcG9ydCBjaGFpbmluZ1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGZ1bmN0aW9uIHRvIHRoZSBhcnJheS5cbiAgICAgKiBcbiAgICAgKiBGb3IgaGlzdG9yaWNhbCBwdXJwb3NlcyB3ZSBzdXBwb3J0IHNldmVyYWwgdHlwZXNcbiAgICAgKiBvZiBmdW5jdGlvbi4gIEl0J3MgcHJlZmVyYWJsZSB0byB1c2Uge0BsaW5rIE1haGFmdW5jfVxuICAgICAqIG9iamVjdHMsIG9yIG90aGVyIHtAbGluayBNYWhhZnVuY0FycmF5fSdzLiAgQnV0IHdlXG4gICAgICogYWxzbyBhbGxvdyBiYXJlIGZ1bmN0aW9ucy5cbiAgICAgKiBcbiAgICAgKiBAcGFyYW0gZnVuYyBBIHNpbmdsZSBpdGVtIG9mIHR5cGUge0BsaW5rIE1haGFmdW5jVHlwZX1cbiAgICAgKiBAcmV0dXJucyBUbyBzdXBwb3J0IGNoYWluaW5nLCB0aGUgYXJyYXkgaXMgcmV0dXJuZWRcbiAgICAgKi9cbiAgICBhZGRGaW5hbE1haGFmdW5jKGZ1bmM6IE1haGFmdW5jVHlwZSk6IE1haGFmdW5jQXJyYXkge1xuICAgICAgICBpZiAoIShmdW5jIGluc3RhbmNlb2YgTWFoYWZ1bmNcbiAgICAgICAgICAgfHwgZnVuYyBpbnN0YW5jZW9mIE1haGFmdW5jQXJyYXlcbiAgICAgICAgICAgfHwgdHlwZW9mIGZ1bmMgPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgfHwgQXJyYXkuaXNBcnJheShmdW5jKSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkltcHJvcGVyIGFkZGl0aW9uIFwiKyB1dGlsLmluc3BlY3QoZnVuYykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5maW5hbF9mdW5jdGlvbnMucHVzaChmdW5jKTtcbiAgICAgICAgICAgIGlmIChmdW5jIGluc3RhbmNlb2YgTWFoYWZ1bmMpIHtcbiAgICAgICAgICAgICAgICBmdW5jLmFycmF5ID0gdGhpcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpczsgLy8gc3VwcG9ydCBjaGFpbmluZ1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEV4ZWN1dGUgdGhlIGZ1bmN0aW9ucyBpbiB0aGUgYXJyYXkuXG4gICAgICogXG4gICAgICogQHBhcmFtICQgVGhlIHBhcnNlZCBmb3JtIG9mIHRoZSBIVE1MIHJlYWR5IHRvIHVzZSB3aXRoIENoZWVyaW8gZnVuY3Rpb25zXG4gICAgICogQHBhcmFtIG1ldGFkYXRhIEEgbWV0YWRhdGEgb2JqZWN0IHN1cHBsaWVkIGJ5IHRoZSBhcHBsaWNhdGlvbiwgYW5kIHBhc3NlZCB0aHJvdWdoIHRvIGZ1bmN0aW9ucy5cbiAgICAgKiBAcGFyYW0gZGlydHkgQSBmdW5jdGlvbiBwcm92aWRlZCBieSB7QGxpbmsgcHJvY2Vzc0FzeW5jfSB0aGF0IG5vdGlmaWVzIHdoZXRoZXIgYSBmdW5jdGlvbiBoYXMgaW5zZXJ0ZWQgc29tZXRoaW5nIGluIHRoZSBIVE1MIHdoaWNoIHJlcXVpcmVzIGZ1cnRoZXIgcHJvY2Vzc2luZy5cbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgICBhc3luYyBwcm9jZXNzKCQsIG1ldGFkYXRhLCBkaXJ0eTogRnVuY3Rpb24pIHtcbiAgICAgICAgbG9nUHJvY2Vzc2luZyhgTWFoYWJodXRhIHN0YXJ0aW5nIGFycmF5ICR7dGhpcy5uYW1lfWApO1xuICAgICAgICBjb25zdCBsb29wcyA9IFtdO1xuICAgICAgICAvLyBjb25zdCBzdGFydFByb2Nlc3NpbmcgPSBuZXcgRGF0ZSgpO1xuXG4gICAgICAgIC8vIFJ1biB0aGUgZnVuY3Rpb25zLCB0aGVuIHJ1biB0aGUgZmluYWxfZnVuY3Rpb25zXG4gICAgICAgIGZvciAobGV0IGZ1bmNsaXN0IG9mIFsgdGhpcy5mdW5jdGlvbnMsIHRoaXMuZmluYWxfZnVuY3Rpb25zXSkge1xuICAgICAgICAgICAgZm9yIChsZXQgbWFoYWZ1bmMgb2YgZnVuY2xpc3QpIHtcbiAgICAgICAgICAgICAgICBpZiAobWFoYWZ1bmMgaW5zdGFuY2VvZiBDdXN0b21FbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZ1Byb2Nlc3NpbmcoYE1haGFiaHV0YSBjYWxsaW5nIEN1c3RvbUVsZW1lbnQgJHt0aGlzLm5hbWV9ICR7bWFoYWZ1bmMuZWxlbWVudE5hbWV9YCk7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBtYWhhZnVuYy5wcm9jZXNzQWxsKCQsIG1ldGFkYXRhLCBkaXJ0eSk7XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVyckN1c3RvbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNYWhhYmh1dGEgJHt0aGlzLm5hbWV9IGNhdWdodCBlcnJvciBpbiBDdXN0b21FbGVtZW50KCR7bWFoYWZ1bmMuZWxlbWVudE5hbWV9KTogJHtlcnJDdXN0b20ubWVzc2FnZX1gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBsb29wcy5wdXNoKGAuLi4gQ3VzdG9tRWxlbWVudCAke21haGFmdW5jLmVsZW1lbnROYW1lfSAkeyhuZXcgRGF0ZSgpIC0gc3RhcnRQcm9jZXNzaW5nKSAvIDEwMDB9IHNlY29uZHNgKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1haGFmdW5jIGluc3RhbmNlb2YgTXVuZ2VyKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZ1Byb2Nlc3NpbmcoYE1haGFiaHV0YSBjYWxsaW5nIE11bmdlciAke3RoaXMubmFtZX0gJHttYWhhZnVuYy5zZWxlY3Rvcn1gKTtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG1haGFmdW5jLnByb2Nlc3NBbGwoJCwgbWV0YWRhdGEsIGRpcnR5KTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyTXVuZ2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1haGFiaHV0YSAke3RoaXMubmFtZX0gY2F1Z2h0IGVycm9yIGluIE11bmdlcigke21haGFmdW5jLnNlbGVjdG9yfSk6ICR7ZXJyTXVuZ2VyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbG9nUHJvY2Vzc2luZyhgTWFoYWJodXRhIEZJTklTSEVEIE11bmdlciAke3RoaXMubmFtZX0gJHttYWhhZnVuYy5zZWxlY3Rvcn1gKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gbG9vcHMucHVzaChgLi4uIE11bmdlciAke21haGFmdW5jLnNlbGVjdG9yfSAkeyhuZXcgRGF0ZSgpIC0gc3RhcnRQcm9jZXNzaW5nKSAvIDEwMDB9IHNlY29uZHNgKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1haGFmdW5jIGluc3RhbmNlb2YgUGFnZVByb2Nlc3Nvcikge1xuICAgICAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSB0ZXN0aW5nXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IF9zdGFydCA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIGxvZ1Byb2Nlc3NpbmcoYE1haGFiaHV0YSBjYWxsaW5nICR7dGhpcy5uYW1lfSBQYWdlUHJvY2Vzc29yIGApO1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgbWFoYWZ1bmMucHJvY2VzcygkLCBtZXRhZGF0YSwgZGlydHkpO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJQYWdlUHJvY2Vzc29yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1haGFiaHV0YSAke3RoaXMubmFtZX0gY2F1Z2h0IGVycm9yIGluIFBhZ2VQcm9jZXNzb3I6ICR7ZXJyUGFnZVByb2Nlc3Nvci5tZXNzYWdlfWApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIFBlcmZvcm1hbmNlIHRlc3RpbmdcbiAgICAgICAgICAgICAgICAgICAgbG9nUGVyZm9ybWFuY2UoX3N0YXJ0LCBgUGFnZVByb2Nlc3NvciAke3RoaXMubmFtZX1gKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gbG9vcHMucHVzaChgLi4uIFBhZ2VQcm9jZXNzb3IgJHsobmV3IERhdGUoKSAtIHN0YXJ0UHJvY2Vzc2luZykgLyAxMDAwfSBzZWNvbmRzYCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtYWhhZnVuYyBpbnN0YW5jZW9mIE1haGFmdW5jQXJyYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gUGVyZm9ybWFuY2UgdGVzdGluZ1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBfc3RhcnQgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cyA9IGF3YWl0IG1haGFmdW5jLnByb2Nlc3MoJCwgbWV0YWRhdGEsIGRpcnR5KTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyTWFoYWZ1bmNBcnJheSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNYWhhYmh1dGEgJHt0aGlzLm5hbWV9IGNhdWdodCBlcnJvciBpbiBNYWhhZnVuY0FycmF5OiAke2Vyck1haGFmdW5jQXJyYXkubWVzc2FnZX1gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSB0ZXN0aW5nXG4gICAgICAgICAgICAgICAgICAgIGxvZ1BlcmZvcm1hbmNlKF9zdGFydCwgYE1haGFmdW5jQXJyYXkgJHt0aGlzLm5hbWV9ICR7bWFoYWZ1bmMubmFtZX1gKVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIHJlc3VsdHMuZm9yRWFjaChyZXN1bHQgPT4geyBsb29wcy5wdXNoKGAgICAgLi4uIFwiJHttYWhhZnVuYy5uYW1lfSByZXN1bHRcIiAke3Jlc3VsdH0gJHsobmV3IERhdGUoKSAtIHN0YXJ0UHJvY2Vzc2luZykgLyAxMDAwfSBzZWNvbmRzYCk7IH0pO1xuICAgICAgICAgICAgICAgICAgICAvLyBsb29wcy5wdXNoKGAuLi4gTWFoYWZ1bmNBcnJheSAke21haGFmdW5jLm5hbWV9ICR7KG5ldyBEYXRlKCkgLSBzdGFydFByb2Nlc3NpbmcpIC8gMTAwMH0gc2Vjb25kc2ApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG1haGFmdW5jID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFBlcmZvcm1hbmNlIHRlc3RpbmdcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgX3N0YXJ0ID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgbG9nUHJvY2Vzc2luZyhgTWFoYWJodXRhIGNhbGxpbmcgYW4gJHt0aGlzLm5hbWV9IFwiZnVuY3Rpb25cIiBgKTtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWhhZnVuYygkLCBtZXRhZGF0YSwgZGlydHksIGVyciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJlc29sdmUoJ29rJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyRnVuY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTWFoYWJodXRhICR7dGhpcy5uYW1lfSBjYXVnaHQgZXJyb3IgaW4gZnVuY3Rpb246ICR7ZXJyRnVuY3Rpb24ubWVzc2FnZX1gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSB0ZXN0aW5nXG4gICAgICAgICAgICAgICAgICAgIGxvZ1BlcmZvcm1hbmNlKF9zdGFydCwgYGZ1bmN0aW9uICR7dGhpcy5uYW1lfWApO1xuICAgICAgICAgICAgICAgICAgICAvLyBsb29wcy5wdXNoKGAuLi4gTWFoYWZ1bmNBcnJheSBcImZ1bmN0aW9uXCIgJHsobmV3IERhdGUoKSAtIHN0YXJ0UHJvY2Vzc2luZykgLyAxMDAwfSBzZWNvbmRzYCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG1haGFmdW5jKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSB0ZXN0aW5nXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IF9zdGFydCA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBtaE9iaiA9IG5ldyBNYWhhZnVuY0FycmF5KFwiaW5saW5lXCIsIHRoaXMub3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIG1oT2JqLnNldE1haGFmdW5jQXJyYXkobWFoYWZ1bmMpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IG1oT2JqLnByb2Nlc3MoJCwgbWV0YWRhdGEsIGRpcnR5KTtcbiAgICAgICAgICAgICAgICAgICAgLy8gUGVyZm9ybWFuY2UgdGVzdGluZ1xuICAgICAgICAgICAgICAgICAgICBsb2dQZXJmb3JtYW5jZShfc3RhcnQsIGBBcnJheSAke3RoaXMubmFtZX0gaW5saW5lYCk7XG4gICAgICAgICAgICAgICAgICAgIC8vIHJlc3VsdHMuZm9yRWFjaChyZXN1bHQgPT4geyBsb29wcy5wdXNoKGAgICAgLi4uIFwiaW5saW5lIHJlc3VsdFwiICR7cmVzdWx0fSAkeyhuZXcgRGF0ZSgpIC0gc3RhcnRQcm9jZXNzaW5nKSAvIDEwMDB9IHNlY29uZHNgKTsgfSk7XG4gICAgICAgICAgICAgICAgICAgIC8vIGxvb3BzLnB1c2goYC4uLiBNYWhhZnVuY0FycmF5IFwiaW5saW5lIGFycmF5XCIgJHsobmV3IERhdGUoKSAtIHN0YXJ0UHJvY2Vzc2luZykgLyAxMDAwfSBzZWNvbmRzYCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQkFEIE1BSEFGVU5DIGluIGFycmF5ICR7dGhpcy5uYW1lfSAtICR7dXRpbC5pbnNwZWN0KG1haGFmdW5jKX1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gcmV0dXJuICQuaHRtbCgpO1xuICAgICAgICByZXR1cm4gbG9vcHM7XG4gICAgfVxufVxuIl19