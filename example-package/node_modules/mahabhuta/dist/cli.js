"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const commander_1 = require("commander");
const mahabhuta = __importStar(require("./index.js"));
const fs_1 = require("fs");
const yaml_1 = __importDefault(require("yaml"));
// mahabhuta process file.html -o file2.html -m mahafuncs.js -m mahafuncs2.js -m mahafuncs3.js --options options.yaml --metadata metadata.yaml
const packageJSON = require('../package.json');
process.title = 'mahabhuta';
commander_1.program.version(packageJSON.version, '-v, --version', 'output the current version');
// DEFAULT CHEERIO CONFIG
// Cheerio Config
// Trace Processing
// Trace Performance
// metadata
commander_1.program
    .command('process <inputFN>')
    .description('Process an input file using supplied mahabhuta arrays')
    .option('-o, --output <outputFN>', 'Specify output file name')
    .option('-m, --module <mahafuncFN...>', 'JavaScript file (or files) containing a defined MahafuncArray')
    .option('-c, --config <cheerioConfig>', 'YAML file containing Cheerio configuration')
    .option('--trace-performance', 'Trace performance data')
    .option('--trace-processing', 'Trace processing')
    .option('--metadata <metadataFN>', 'YAML file containing data')
    .option('--options <optionsFN', 'YAML file containing options for mahabhuta arrays')
    .option('--partials', 'Enable the <partial> MahaFuncs')
    .option('--partials-dir <dirFN...>', 'Directory name for partial templates')
    .action(async (inputFN, cmdObj) => {
    try {
        // console.log(inputFN);
        // console.log(cmdObj);
        if (!inputFN)
            throw new Error('No input file specified');
        if (cmdObj.config) {
            const txt = await fs_1.promises.readFile(cmdObj.config, 'utf8');
            // console.log(`Read config ${cmdObj.config}`, txt);
            const cheerioConfig = yaml_1.default.parse(txt);
            // For cheerio 1.0.0-rc.10 we need to use this setting.
            // If the configuration has set this, we must not
            // override their setting.  But, generally, for correct
            // operation and handling of Mahabhuta tags, we need
            // this setting to be <code>true</code>
            if (!('_useHtmlParser2' in cheerioConfig)) {
                cheerioConfig._useHtmlParser2 = true;
            }
            // console.log(`Setting cheerioConfig `, cheerioConfig);
            mahabhuta.config(cheerioConfig);
        }
        // console.log('After config');
        if (cmdObj.tracePerformance)
            mahabhuta.setTracePerformance(true);
        if (cmdObj.traceProcessing)
            mahabhuta.setTraceProcessing(true);
        let metadata = {};
        if (cmdObj.metadata) {
            const txt = await fs_1.promises.readFile(cmdObj.metadata, 'utf8');
            // console.log(`Read metadata ${cmdObj.metadata}`, txt);
            metadata = yaml_1.default.parse(txt);
        }
        // console.log('After metadata');
        let mhOptions = {};
        if (cmdObj.options) {
            const txt = await fs_1.promises.readFile(cmdObj.options, 'utf8');
            // console.log(`Read options ${cmdObj.options}`, txt);
            mhOptions = yaml_1.default.parse(txt);
        }
        // console.log('After options');
        const inputFile = await fs_1.promises.readFile(inputFN, 'utf8');
        // console.log(`input file ${inputFile}`, inputFile);
        const mahafuncs = [];
        for (const arrayFN of cmdObj.module) {
            const arrayModule = require(arrayFN);
            // console.log(`MahafuncArray ${arrayFN}`);
            if (!arrayModule.mahabhutaArray) {
                throw new Error(`No mahabhutaArray function in ${arrayFN}`);
            }
            mahafuncs.push(arrayModule.mahabhutaArray(mhOptions));
        }
        let partialsModule;
        if (cmdObj.partials) {
            partialsModule = require('../maha/partial.js');
            // console.log(partialsModule);
            if (!partialsModule.configuration.partialDirs) {
                partialsModule.configuration.partialDirs = [];
            }
            if (cmdObj.partialsDir) {
                for (const dirFN of cmdObj.partialsDir) {
                    partialsModule.configuration.partialDirs.push(dirFN);
                }
            }
            mahafuncs.push(partialsModule.mahabhutaArray(mhOptions));
        }
        const output = await mahabhuta.processAsync(inputFile, metadata, mahafuncs);
        if (cmdObj.output) {
            await fs_1.promises.writeFile(cmdObj.output, output, 'utf8');
        }
        else {
            // console.log('////////////////////////// OUTPUT');
            console.log(output);
            // console.log('\\\\\\\\\\\\\\\\\\\\\\\\\\ OUTPUT');
        }
    }
    catch (e) {
        console.error(`process command ERRORED ${e.stack}`);
    }
});
commander_1.program.parse();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vbGliL2NsaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSx5Q0FBb0M7QUFDcEMsc0RBQXdDO0FBQ3hDLDJCQUFxQztBQUNyQyxnREFBd0I7QUFFeEIsOElBQThJO0FBRTlJLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRS9DLE9BQU8sQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDO0FBQzVCLG1CQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsZUFBZSxFQUFFLDRCQUE0QixDQUFDLENBQUM7QUFFcEYseUJBQXlCO0FBRXpCLGlCQUFpQjtBQUNqQixtQkFBbUI7QUFDbkIsb0JBQW9CO0FBQ3BCLFdBQVc7QUFFWCxtQkFBTztLQUNGLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztLQUM1QixXQUFXLENBQUMsdURBQXVELENBQUM7S0FDcEUsTUFBTSxDQUFDLHlCQUF5QixFQUFFLDBCQUEwQixDQUFDO0tBQzdELE1BQU0sQ0FBQyw4QkFBOEIsRUFBRSwrREFBK0QsQ0FBQztLQUN2RyxNQUFNLENBQUMsOEJBQThCLEVBQUUsNENBQTRDLENBQUM7S0FDcEYsTUFBTSxDQUFDLHFCQUFxQixFQUFFLHdCQUF3QixDQUFDO0tBQ3ZELE1BQU0sQ0FBQyxvQkFBb0IsRUFBRSxrQkFBa0IsQ0FBQztLQUNoRCxNQUFNLENBQUMseUJBQXlCLEVBQUUsMkJBQTJCLENBQUM7S0FDOUQsTUFBTSxDQUFDLHNCQUFzQixFQUFFLG1EQUFtRCxDQUFDO0tBQ25GLE1BQU0sQ0FBQyxZQUFZLEVBQUUsZ0NBQWdDLENBQUM7S0FDdEQsTUFBTSxDQUFDLDJCQUEyQixFQUFFLHNDQUFzQyxDQUFDO0tBQzNFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO0lBQzlCLElBQUk7UUFDQSx3QkFB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LENBQUM7aUJBQ3hEO2FBQ0o7WUFDRCxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztTQUM1RDtRQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sU0FBUyxDQUFDLFlBQVksQ0FDdkMsU0FBUyxFQUNULFFBQVEsRUFDUixTQUFTLENBQ1osQ0FBQztRQUNGLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRTtZQUNmLE1BQU0sYUFBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztTQUN0RDthQUFNO1lBQ0gsb0RBQW9EO1lBQ3BELE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDcEIsb0RBQW9EO1NBQ3ZEO0tBQ0o7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0tBQ3ZEO0FBRUwsQ0FBQyxDQUFDLENBQUM7QUFFUCxtQkFBTyxDQUFDLEtBQUssRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBwcm9ncmFtIH0gZnJvbSAnY29tbWFuZGVyJztcbmltcG9ydCAqIGFzIG1haGFiaHV0YSBmcm9tICcuL2luZGV4LmpzJztcbmltcG9ydCB7IHByb21pc2VzIGFzIGZzcCB9IGZyb20gJ2ZzJztcbmltcG9ydCBZQU1MIGZyb20gJ3lhbWwnO1xuXG4vLyBtYWhhYmh1dGEgcHJvY2VzcyBmaWxlLmh0bWwgLW8gZmlsZTIuaHRtbCAtbSBtYWhhZnVuY3MuanMgLW0gbWFoYWZ1bmNzMi5qcyAtbSBtYWhhZnVuY3MzLmpzIC0tb3B0aW9ucyBvcHRpb25zLnlhbWwgLS1tZXRhZGF0YSBtZXRhZGF0YS55YW1sXG5cbmNvbnN0IHBhY2thZ2VKU09OID0gcmVxdWlyZSgnLi4vcGFja2FnZS5qc29uJyk7XG5cbnByb2Nlc3MudGl0bGUgPSAnbWFoYWJodXRhJztcbnByb2dyYW0udmVyc2lvbihwYWNrYWdlSlNPTi52ZXJzaW9uLCAnLXYsIC0tdmVyc2lvbicsICdvdXRwdXQgdGhlIGN1cnJlbnQgdmVyc2lvbicpO1xuXG4vLyBERUZBVUxUIENIRUVSSU8gQ09ORklHXG5cbi8vIENoZWVyaW8gQ29uZmlnXG4vLyBUcmFjZSBQcm9jZXNzaW5nXG4vLyBUcmFjZSBQZXJmb3JtYW5jZVxuLy8gbWV0YWRhdGFcblxucHJvZ3JhbVxuICAgIC5jb21tYW5kKCdwcm9jZXNzIDxpbnB1dEZOPicpXG4gICAgLmRlc2NyaXB0aW9uKCdQcm9jZXNzIGFuIGlucHV0IGZpbGUgdXNpbmcgc3VwcGxpZWQgbWFoYWJodXRhIGFycmF5cycpXG4gICAgLm9wdGlvbignLW8sIC0tb3V0cHV0IDxvdXRwdXRGTj4nLCAnU3BlY2lmeSBvdXRwdXQgZmlsZSBuYW1lJylcbiAgICAub3B0aW9uKCctbSwgLS1tb2R1bGUgPG1haGFmdW5jRk4uLi4+JywgJ0phdmFTY3JpcHQgZmlsZSAob3IgZmlsZXMpIGNvbnRhaW5pbmcgYSBkZWZpbmVkIE1haGFmdW5jQXJyYXknKVxuICAgIC5vcHRpb24oJy1jLCAtLWNvbmZpZyA8Y2hlZXJpb0NvbmZpZz4nLCAnWUFNTCBmaWxlIGNvbnRhaW5pbmcgQ2hlZXJpbyBjb25maWd1cmF0aW9uJylcbiAgICAub3B0aW9uKCctLXRyYWNlLXBlcmZvcm1hbmNlJywgJ1RyYWNlIHBlcmZvcm1hbmNlIGRhdGEnKVxuICAgIC5vcHRpb24oJy0tdHJhY2UtcHJvY2Vzc2luZycsICdUcmFjZSBwcm9jZXNzaW5nJylcbiAgICAub3B0aW9uKCctLW1ldGFkYXRhIDxtZXRhZGF0YUZOPicsICdZQU1MIGZpbGUgY29udGFpbmluZyBkYXRhJylcbiAgICAub3B0aW9uKCctLW9wdGlvbnMgPG9wdGlvbnNGTicsICdZQU1MIGZpbGUgY29udGFpbmluZyBvcHRpb25zIGZvciBtYWhhYmh1dGEgYXJyYXlzJylcbiAgICAub3B0aW9uKCctLXBhcnRpYWxzJywgJ0VuYWJsZSB0aGUgPHBhcnRpYWw+IE1haGFGdW5jcycpXG4gICAgLm9wdGlvbignLS1wYXJ0aWFscy1kaXIgPGRpckZOLi4uPicsICdEaXJlY3RvcnkgbmFtZSBmb3IgcGFydGlhbCB0ZW1wbGF0ZXMnKVxuICAgIC5hY3Rpb24oYXN5bmMgKGlucHV0Rk4sIGNtZE9iaikgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coaW5wdXRGTik7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhjbWRPYmopO1xuXG4gICAgICAgICAgICBpZiAoIWlucHV0Rk4pIHRocm93IG5ldyBFcnJvcignTm8gaW5wdXQgZmlsZSBzcGVjaWZpZWQnKTtcblxuICAgICAgICAgICAgaWYgKGNtZE9iai5jb25maWcpIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHR4dCA9IGF3YWl0IGZzcC5yZWFkRmlsZShjbWRPYmouY29uZmlnLCAndXRmOCcpO1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBSZWFkIGNvbmZpZyAke2NtZE9iai5jb25maWd9YCwgdHh0KTtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGVlcmlvQ29uZmlnID0gWUFNTC5wYXJzZSh0eHQpO1xuXG4gICAgICAgICAgICAgICAgLy8gRm9yIGNoZWVyaW8gMS4wLjAtcmMuMTAgd2UgbmVlZCB0byB1c2UgdGhpcyBzZXR0aW5nLlxuICAgICAgICAgICAgICAgIC8vIElmIHRoZSBjb25maWd1cmF0aW9uIGhhcyBzZXQgdGhpcywgd2UgbXVzdCBub3RcbiAgICAgICAgICAgICAgICAvLyBvdmVycmlkZSB0aGVpciBzZXR0aW5nLiAgQnV0LCBnZW5lcmFsbHksIGZvciBjb3JyZWN0XG4gICAgICAgICAgICAgICAgLy8gb3BlcmF0aW9uIGFuZCBoYW5kbGluZyBvZiBNYWhhYmh1dGEgdGFncywgd2UgbmVlZFxuICAgICAgICAgICAgICAgIC8vIHRoaXMgc2V0dGluZyB0byBiZSA8Y29kZT50cnVlPC9jb2RlPlxuICAgICAgICAgICAgICAgIGlmICghKCdfdXNlSHRtbFBhcnNlcjInIGluIGNoZWVyaW9Db25maWcpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoZWVyaW9Db25maWcuX3VzZUh0bWxQYXJzZXIyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNldHRpbmcgY2hlZXJpb0NvbmZpZyBgLCBjaGVlcmlvQ29uZmlnKTtcbiAgICAgICAgICAgICAgICBtYWhhYmh1dGEuY29uZmlnKGNoZWVyaW9Db25maWcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ0FmdGVyIGNvbmZpZycpO1xuXG4gICAgICAgICAgICBpZiAoY21kT2JqLnRyYWNlUGVyZm9ybWFuY2UpIG1haGFiaHV0YS5zZXRUcmFjZVBlcmZvcm1hbmNlKHRydWUpO1xuICAgICAgICAgICAgaWYgKGNtZE9iai50cmFjZVByb2Nlc3NpbmcpICBtYWhhYmh1dGEuc2V0VHJhY2VQcm9jZXNzaW5nKHRydWUpO1xuXG4gICAgICAgICAgICBsZXQgbWV0YWRhdGEgPSB7fTtcbiAgICAgICAgICAgIGlmIChjbWRPYmoubWV0YWRhdGEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0eHQgPSBhd2FpdCBmc3AucmVhZEZpbGUoY21kT2JqLm1ldGFkYXRhLCAndXRmOCcpO1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBSZWFkIG1ldGFkYXRhICR7Y21kT2JqLm1ldGFkYXRhfWAsIHR4dCk7XG4gICAgICAgICAgICAgICAgbWV0YWRhdGEgPSBZQU1MLnBhcnNlKHR4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnQWZ0ZXIgbWV0YWRhdGEnKTtcblxuICAgICAgICAgICAgbGV0IG1oT3B0aW9ucyA9IHt9O1xuICAgICAgICAgICAgaWYgKGNtZE9iai5vcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdHh0ID0gYXdhaXQgZnNwLnJlYWRGaWxlKGNtZE9iai5vcHRpb25zLCAndXRmOCcpO1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBSZWFkIG9wdGlvbnMgJHtjbWRPYmoub3B0aW9uc31gLCB0eHQpO1xuICAgICAgICAgICAgICAgIG1oT3B0aW9ucyA9IFlBTUwucGFyc2UodHh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdBZnRlciBvcHRpb25zJyk7XG5cbiAgICAgICAgICAgIGNvbnN0IGlucHV0RmlsZSA9IGF3YWl0IGZzcC5yZWFkRmlsZShpbnB1dEZOLCAndXRmOCcpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYGlucHV0IGZpbGUgJHtpbnB1dEZpbGV9YCwgaW5wdXRGaWxlKTtcblxuICAgICAgICAgICAgY29uc3QgbWFoYWZ1bmNzID0gW107XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGFycmF5Rk4gb2YgY21kT2JqLm1vZHVsZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFycmF5TW9kdWxlID0gcmVxdWlyZShhcnJheUZOKTtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgTWFoYWZ1bmNBcnJheSAke2FycmF5Rk59YCk7XG4gICAgICAgICAgICAgICAgaWYgKCFhcnJheU1vZHVsZS5tYWhhYmh1dGFBcnJheSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIG1haGFiaHV0YUFycmF5IGZ1bmN0aW9uIGluICR7YXJyYXlGTn1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbWFoYWZ1bmNzLnB1c2goYXJyYXlNb2R1bGUubWFoYWJodXRhQXJyYXkobWhPcHRpb25zKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBwYXJ0aWFsc01vZHVsZTtcbiAgICAgICAgICAgIGlmIChjbWRPYmoucGFydGlhbHMpIHtcbiAgICAgICAgICAgICAgICBwYXJ0aWFsc01vZHVsZSA9IHJlcXVpcmUoJy4uL21haGEvcGFydGlhbC5qcycpO1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHBhcnRpYWxzTW9kdWxlKTtcbiAgICAgICAgICAgICAgICBpZiAoIXBhcnRpYWxzTW9kdWxlLmNvbmZpZ3VyYXRpb24ucGFydGlhbERpcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydGlhbHNNb2R1bGUuY29uZmlndXJhdGlvbi5wYXJ0aWFsRGlycyA9IFtdO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjbWRPYmoucGFydGlhbHNEaXIpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBkaXJGTiBvZiBjbWRPYmoucGFydGlhbHNEaXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWxzTW9kdWxlLmNvbmZpZ3VyYXRpb24ucGFydGlhbERpcnMucHVzaChkaXJGTik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbWFoYWZ1bmNzLnB1c2gocGFydGlhbHNNb2R1bGUubWFoYWJodXRhQXJyYXkobWhPcHRpb25zKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IG1haGFiaHV0YS5wcm9jZXNzQXN5bmMoXG4gICAgICAgICAgICAgICAgaW5wdXRGaWxlLFxuICAgICAgICAgICAgICAgIG1ldGFkYXRhLFxuICAgICAgICAgICAgICAgIG1haGFmdW5jc1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmIChjbWRPYmoub3V0cHV0KSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZnNwLndyaXRlRmlsZShjbWRPYmoub3V0cHV0LCBvdXRwdXQsICd1dGY4Jyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCcvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLyBPVVRQVVQnKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhvdXRwdXQpO1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcIE9VVFBVVCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBwcm9jZXNzIGNvbW1hbmQgRVJST1JFRCAke2Uuc3RhY2t9YCk7XG4gICAgICAgIH1cblxuICAgIH0pO1xuXG5wcm9ncmFtLnBhcnNlKCk7XG4iXX0=